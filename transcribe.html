<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <meta charset="UTF-8">
    <title>Whallop & Co. | Transcriber</title>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 40px; background: #0a0a0b; color: #e0e0e0; max-width: 900px; margin: auto; }
        .card { background: #1a1a1c; padding: 30px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #c5a059; font-size: 0.8rem; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; background: #0a0a0b; border: 1px solid #333; color: white; 
            padding: 12px; margin-bottom: 20px; box-sizing: border-box; border-radius: 4px;
        }
        textarea { font-family: 'Lora', serif; line-height: 1.6; }
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag-btn { background: #333; color: #c5a059; border: 1px solid #c5a059; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; border-radius: 4px; }
        button#main-gen { 
            background: #c5a059; color: #0a0a0b; border: none; padding: 15px 30px; 
            font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%;
        }
        .output-box { 
            background: #000; padding: 20px; margin-top: 30px; border: 1px dashed #c5a059; 
            white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; color: #a0a0a0;
        }

        @media (max-width: 600px) {
            div[style*="display: flex"] {
                flex-direction: column !important;
                gap: 0 !important;
            }
        }

    </style>
</head>
<body>
    <div class="card">
        <h1>Manuscript Transcriber</h1>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;"><label>Title</label><input type="text" id="title" placeholder="Title"></div>
            <div style="flex: 1;"><label>Author</label><input type="text" id="author" placeholder="Author"></div>
        </div>

        <div style="flex: 1;">
            <label>Volume</label>
            <input type="number" id="volume" value="1" min="1">
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;"><label>Date</label><input type="date" id="date"></div>
            <div style="flex: 1;">
                <label>Category</label>
                <select id="category">
                    <option value="poetry">Verse</option>
                    <option value="prose">Prose</option>
                    <option value="research">Research</option>
                </select>
            </div>
        </div>

        <label>Short Summary (Leave Blank for Verse)</label>
        <textarea id="summaryInput" style="height: 100px;" placeholder="Enter a brief summary, for the home page..."></textarea>

        <label>Full Manuscript Content</label>
        <div class="controls">
            <button class="tag-btn" onclick="wrapText('b')">Bold</button>
            <button class="tag-btn" onclick="wrapText('i')">Italic</button>
            <button class="tag-btn" onclick="wrapText('u')">Underline</button>
        </div>
        <textarea id="rawInput" style="height: 250px;"></textarea>
        
        <button id="main-gen" onclick="generateJSON()">Generate Archive Entry</button>

        <div id="result" class="output-box">JSON output will appear here...</div>
    </div>

<script>
        function wrapText(tag) {
            const area = document.getElementById('rawInput');
            const start = area.selectionStart;
            const end = area.selectionEnd;
            const text = area.value;
            area.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
        }

        function truncatePreservingHTML(html, wordLimit) {
            html = html.replace(/\n/g, '<br>');

            const div = document.createElement('div');
            div.innerHTML = html;
            
            let wordCount = 0;
            let result = '';
            
            function traverse(node) {
                if (wordCount >= wordLimit) return;

                if (node.nodeType === Node.TEXT_NODE) {
                    const words = node.textContent.split(/\s+/).filter(w => w.length > 0);
                    if (wordCount + words.length > wordLimit) {
                        const remaining = wordLimit - wordCount;
                        result += words.slice(0, remaining).join(' ') + ' ...';
                        wordCount = wordLimit; 
                    } else {
                        result += node.textContent;
                        wordCount += words.length;
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const tagName = node.tagName.toLowerCase();
                    
                    if (tagName === 'br') {
                        result += '\n'; // Convert back to newline for the summary
                        return;
                    }

                    result += `<${tagName}>`;
                    for (let i = 0; i < node.childNodes.length; i++) {
                        traverse(node.childNodes[i]);
                        if (wordCount >= wordLimit) break;
                    }
                    result += `</${tagName}>`;
                }
            }

            for (let i = 0; i < div.childNodes.length; i++) {
                traverse(div.childNodes[i]);
                if (wordCount >= wordLimit) break;
            }
            
            return result;
        }

        function generateJSON() {
            const raw = document.getElementById('rawInput').value;
            const summaryRaw = document.getElementById('summaryInput').value;
            const title = document.getElementById('title').value || "Untitled";
            const author = document.getElementById('author').value || "Anonymous";
            const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
            const category = document.getElementById('category').value;
            const vol = parseInt(document.getElementById('volume').value) || 1;

            // 1. Generate Unique ID
            const idSlug = author.toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s+/g, '-') + "-" + title.toLowerCase().replace(/[^\w\s]/gi, '').replace(/\s+/g, '-') + "-" + Math.floor(1000 + Math.random() * 9000);
            const uniqueId = `${idSlug}`;

            // 2. Prepare Full Content
            const cleanContent = raw
                .replace(/\\/g, "\\\\")
                .replace(/"/g, '\\"')
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "");

            // 3. Prepare Summary (Fallback to Smart Truncate if empty)
            let finalSummary = summaryRaw.trim();
            
            if (!finalSummary) {
                finalSummary = truncatePreservingHTML(raw, 25);
            }
            
            // Escape the summary for JSON
            finalSummary = finalSummary
                .replace(/\\/g, "\\\\")
                .replace(/"/g, '\\"')
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "");

            // 4. Create Metadata Entry
            const metaEntry = {
                id: uniqueId,
                category: category,
                title: title,
                author: author,
                date: date,
                volume: vol,
                summary: finalSummary, 
                type: category === 'poetry' ? 'poem' : 'essay'
            };

            // 5. Create Library Entry
            const libEntry = {
                id: uniqueId,
                content: cleanContent
            };

            // 6. Output Both
            const output = `
// COPY TO content.json:
${JSON.stringify(metaEntry, null, 2)},

// COPY TO library.json:
${JSON.stringify(libEntry, null, 2)},
            `;

            document.getElementById('result').textContent = output;
        }
    </script>
</body>
</html>