<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="favicon.png">
    <meta charset="UTF-8">
    <title>Whallop & Co. | Transcriber</title>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 40px; background: #0a0a0b; color: #e0e0e0; max-width: 900px; margin: auto; }
        .card { background: #1a1a1c; padding: 30px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #c5a059; font-size: 0.8rem; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; background: #0a0a0b; border: 1px solid #333; color: white; 
            padding: 12px; margin-bottom: 20px; box-sizing: border-box; border-radius: 4px;
        }
        textarea { height: 250px; font-family: 'Lora', serif; line-height: 1.6; }
        .controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag-btn { background: #333; color: #c5a059; border: 1px solid #c5a059; padding: 5px 10px; cursor: pointer; font-size: 0.7rem; border-radius: 4px; }
        button#main-gen { 
            background: #c5a059; color: #0a0a0b; border: none; padding: 15px 30px; 
            font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%;
        }
        .output-box { 
            background: #000; padding: 20px; margin-top: 30px; border: 1px dashed #c5a059; 
            white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; color: #a0a0a0;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Manuscript Transcriber</h1>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;"><label>Title</label><input type="text" id="title" placeholder="Title"></div>
            <div style="flex: 1;"><label>Author</label><input type="text" id="author" placeholder="Author"></div>
        </div>

        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;"><label>Date</label><input type="date" id="date"></div>
            <div style="flex: 1;">
                <label>Category</label>
                <select id="category">
                    <option value="poetry">Verse</option>
                    <option value="prose">Prose</option>
                    <option value="research">Research</option>
                </select>
            </div>
        </div>

        <label>Manuscript Content</label>
        <div class="controls">
            <button class="tag-btn" onclick="wrapText('b')">Bold</button>
            <button class="tag-btn" onclick="wrapText('i')">Italic</button>
            <button class="tag-btn" onclick="wrapText('u')">Underline</button>
        </div>
        <textarea id="rawInput"></textarea>
        
        <button id="main-gen" onclick="generateJSON()">Generate Archive Entry</button>

        <div id="result" class="output-box">JSON output will appear here...</div>
    </div>

    <script>
        function wrapText(tag) {
            const area = document.getElementById('rawInput');
            const start = area.selectionStart;
            const end = area.selectionEnd;
            const text = area.value;
            area.value = text.substring(0, start) + `<${tag}>` + text.substring(start, end) + `</${tag}>` + text.substring(end);
        }

        function generateJSON() {
            const raw = document.getElementById('rawInput').value;
            const title = document.getElementById('title').value || "Untitled";
            const author = document.getElementById('author').value || "Anonymous";
            const date = document.getElementById('date').value || new Date().toISOString().split('T')[0];
            const category = document.getElementById('category').value;

            // NEW: Replace manual formatting with JSON-safe strings
            const cleanContent = raw
                .replace(/\\/g, "\\\\")
                .replace(/"/g, '\\"')   // Escapes quotes used inside HTML tags like <span class="gold">
                .replace(/\n/g, "\\n")
                .replace(/\r/g, "");

            // Strip HTML for the summary so it doesn't look messy in the preview
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = raw;
            const plainTextForSummary = tempDiv.textContent || tempDiv.innerText || "";
            const summaryText = plainTextForSummary.substring(0, 120).replace(/"/g, '\\"') + "...";

            const entry = {
                category: category,
                title: title,
                author: author,
                date: date,
                summary: summaryText,
                content: cleanContent,
                type: category === 'poetry' ? 'poem' : 'essay'
            };

            document.getElementById('result').textContent = JSON.stringify(entry, null, 2) + ",";
        }
    </script>
</body>
</html>